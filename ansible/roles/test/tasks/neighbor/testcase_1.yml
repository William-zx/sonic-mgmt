# Test Case 1   Verify dynamic neighbor learn on interface
- name: flush all neigh entry on dut if
  shell: ip link set {{ dut_if }} arp off && ip link set {{ dut_if }} arp on
  become: yes

- name: flush neigh table
  shell: ip -s -s neigh flush all
  become: yes
  delegate_to: "{{ ptf_host }}"

# use second ip addr of preconfigured ip network as ptf if ip
- name: Gernerate test ipv6 address for host if
  set_fact:
    dut_ip_addr: "{{ dut_ip_neigh_and_mask | ipaddr('address')}}"
    host_ip_addr_and_mask: "{{ dut_ip_neigh_and_mask | ipaddr(2) }}"

- set_fact:
    host_ip_addr: "{{host_ip_addr_and_mask.split('/')[0]}}"
    host_ip_mask: "{{host_ip_addr_and_mask.split('/')[1]}}"

- name: Add test IPv6 address to host if
  shell: ip addr add {{ host_ip_addr_and_mask }} dev eth{{ dut_if_peer_port }}
  delegate_to: "{{ ptf_host }}"

- name: Wait some time for enable ipv6 address
  pause: seconds=5

#  ping to trigger dynamic arp resolve
- name: Execute ping from host to switch to validate all ipv6 addresses
  shell: ping6 {{ dut_ip_addr }} -c 3 -i 0.2 -W2
  register: pingrc
  failed_when: pingrc.rc != 0
  delegate_to: "{{ ptf_host }}"

# verify dynamic neighbor are learned on interface
- name: Use shell to show ipv6 neighbor on dut_if
  shell: ip -6 neigh show
  register: result
  become: true

- fail: msg="dynamic neighbor learned failed."
  when: host_ip_addr not in result.stdout

# Choose the last lag interface for ip forwarding test with dut inteface.
- name: Generate ptf test params
  set_fact:
    forwarding_rif: "{{ minigraph_portchannel_interfaces[-1]['attachto'] }}"
    unexpected_ip_addr_list: []

- name: Wait some time for stream test
  pause: seconds=5

- name: verify ip traffic can be forwarded via this neighbor
  include: roles/test/tasks/ptf_runner.yml
  vars:
        ptf_test_name: Neighbor Test
        ptf_test_dir: ptftests
        ptf_test_path:  arp_test.ArpTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - verbose=True
          - src_port={{ minigraph_port_indices[minigraph_portchannels[forwarding_rif]['members'][0]] }}
          - router_mac=\"{{ ansible_Ethernet0['macaddress'] }}\"
          - dst_ip_addr_list=\"{{ [host_ip_addr] }}\"
          - dst_port={{ dut_if_peer_port }}
          - unexpected_ip_addr_list=\"{{ unexpected_ip_addr_list }}\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/neighbor.NeighborTest.testcase_1.{{ lookup('pipe','date +%Y-%m-%d-%H:%M:%S') }}.log"

# Step 2 flush dynamic neighbor by sonic-clear

# flush host interface ip addr to stop dynamic arp resolve 
- name: Flush all ip address on host rif
  shell: ip addr flush dev eth{{ dut_if_peer_port }}
  delegate_to: "{{ ptf_host }}"

- name: remove arp table
  shell: ip link set arp off dev {{ dut_if }} && ip link set arp on dev {{ dut_if }}
  become: yes

# verify dynamic neighbor are flushed
- name: Use shell to show arp on dut_if
  shell: ip -6 neigh show {{host_ip_addr}}
  register: result
  become: true

- fail: msg="neighbor flush failed."
  when: host_ip_addr in result.stdout and 'FAILED' not in result.stdout

# Choose the last lag interface for ip forwarding test with dut inteface.
- name: Generate ptf test params
  set_fact:
    forwarding_rif: "{{ minigraph_portchannel_interfaces[-1]['attachto'] }}"

- name: Wait some time for stream test
  pause: seconds=5

# verify ip traffic cannot be forwarded via this arp  
- name: Run the test
  include: roles/test/tasks/ptf_runner.yml
  vars:
        ptf_test_name: Neighbor Test
        ptf_test_dir: ptftests
        ptf_test_path: arp_test.ArpTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - verbose=True
          - src_port={{ minigraph_port_indices[minigraph_portchannels[forwarding_rif]['members'][0]] }}
          - router_mac=\"{{ ansible_Ethernet0['macaddress'] }}\"
          - dst_ip_addr_list=\"{{ [host_ip_addr] }}\"
          - dst_port={{ dut_if_peer_port }}
          - unexpected_ip_addr_list=\"{{ [host_ip_addr] }}\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/neighbor.NeighborTest.testcase_1.{{ lookup('pipe','date +%Y-%m-%d-%H:%M:%S') }}.log"

