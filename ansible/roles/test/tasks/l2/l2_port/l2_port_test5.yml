# This is the l2_port.yml helper playbook. l2_port.yml passes dut interface
# to this playbook and in this playbook verify rx value of dut port.    

- block:
  - set_fact: 
      pkt_num: 2000
      expect_rx: 2,000

  - name: clear statistics infor
    shell: portstat -c
    become: true

  - name: Testcase5_step1 Make {{ test_port }} receive {{ pkt_num }} packets
    include: roles/test/tasks/ptf_runner.yml
    vars:
        ptf_test_name: l2_port test
        ptf_test_dir: ptftests
        ptf_test_path: l2_port.L2PortTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - src_port={{ test_port_index }}
          - dst_port={{ minigraph_port_indices[minigraph_vlans.values()[0]['members'][-1]] }}
          - pkt_num={{ pkt_num }}
        ptf_extra_options: "--relax --debug info --log-file /tmp/l2_port_test5_step1.log"

  - pause: seconds=5

  - shell: show interfaces counters|grep "{{ test_port }} "|awk '{print $3}'
    become: true
    register: result

  - debug: msg={{ result.stdout }}

  - fail: msg="{{ test_port }} rx value ERROR!"
    when: result.stdout != "{{ expect_rx }}" and result.stdout != "{{ pkt_num }}"

  rescue:
    - set_fact: failed_case="{{failed_case + ['l2_port_case5']}}"

    - name: show interfaces status check port status
      shell: show interfaces status

    - name: show interfaces counters check port counters
      shell: show interfaces counters

