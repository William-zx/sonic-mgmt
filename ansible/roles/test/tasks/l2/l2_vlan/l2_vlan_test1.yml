
- set_fact:
    vlan_id_list: [1,3,12,56,110,201,999,1500,1688,2002]
    vlan_member_list1: [1,2]
    vlan_member_list2: [3,4] 

- block:
  - name: Create vlan{{vlan_id_list}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_create_vlan.yml
    with_items: "{{ vlan_id_list }}"

  - set_fact: vlan_id=1

  - name: add port1/2 to Vlan{{vlan_id}} with untagged mode
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_add_port_to_vlan_untagged.yml
    with_items: "{{vlan_member_list1}}"

  - set_fact: vlan_id={{vlan_id_list[6]}}

  - name: add port3/4 to Vlan{{vlan_id}} with untagged mode
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_add_port_to_vlan_untagged.yml
    with_items: "{{vlan_member_list2}}"

  - name: Testcase1 verify the l2 traffic will be only forwarded in the vlan
    include: roles/test/tasks/ptf_runner.yml
    vars:
        ptf_test_name: l2_vlan test
        ptf_test_dir: ptftests
        ptf_test_path: l2_vlan.L2VlanTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - testbed_type=\"{{ testbed_type }}\"
          - test_case=\"case1\"
          - test_step=\"step1\"
          - test_member_list1=\"{{ vlan_member_list1 }}\"
          - test_member_list2=\"{{ vlan_member_list2 }}\"
          - test_vid=\"0\"
          - test_pvid=\"0\"
          - test_dut_mac1=\"0\"
          - test_dut_mac2=\"0\"
          - test_ptf_mac1=\"0\"
          - test_ptf_mac2=\"0\"
          - test_ip1=\"0\"
          - test_ip2=\"0\"
          - test_case_str=\"Testcase1 verify the l2 traffic will be only forwarded in the vlan\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/l2_vlan_test1_step1.log"

  - set_fact: vlan_id=1

  - name: Del port1/2 from Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_del_port_from_vlan.yml
    with_items: "{{vlan_member_list1}}"

  - set_fact: vlan_id={{vlan_id_list[6]}}

  - name: Del port3/4 from Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_del_port_from_vlan.yml
    with_items: "{{vlan_member_list2}}"

  - name: Testcase1 verify the l2 traffic will be not forwarded in ports
    include: roles/test/tasks/ptf_runner.yml
    vars:
        ptf_test_name: l2_vlan test
        ptf_test_dir: ptftests
        ptf_test_path: l2_vlan.L2VlanTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - testbed_type=\"{{ testbed_type }}\"
          - test_case=\"case1\"
          - test_step=\"step2\"
          - test_member_list1=\"{{ vlan_member_list1 }}\"
          - test_member_list2=\"{{ vlan_member_list2 }}\"
          - test_vid=\"0\"
          - test_pvid=\"0\"
          - test_dut_mac1=\"0\"
          - test_dut_mac2=\"0\"
          - test_ptf_mac1=\"0\"
          - test_ptf_mac2=\"0\"
          - test_ip1=\"0\"
          - test_ip2=\"0\"
          - test_case_str=\"Testcase1 verify the l2 traffic will be not forwarded in ports\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/l2_vlan_test1_step2.log"

  - set_fact: vlan_id={{vlan_id_list[8]}}

  - name: add port3/4 to Vlan{{vlan_id}} with untagged mode
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_add_port_to_vlan_untagged.yml
    with_items: "{{vlan_member_list2}}"

  - name: shutdown port3/4 on Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_shutdown_port.yml
    with_items: "{{vlan_member_list2}}"

  - name: Flush fdb
    shell: fdbclear
    become: true

  - name: del Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_del_vlan.yml
    with_items: "{{vlan_id}}"

  - name: startup port3/4 on Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_startup_port.yml
    with_items: "{{vlan_member_list2}}"
 
  - name: Testcase1 verify the l2 traffic will be not forwarded in ports
    include: roles/test/tasks/ptf_runner.yml
    vars:
        ptf_test_name: l2_vlan test
        ptf_test_dir: ptftests
        ptf_test_path: l2_vlan.L2VlanTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - testbed_type=\"{{ testbed_type }}\"
          - test_case=\"case1\"
          - test_step=\"step3\"
          - test_member_list1=\"{{ vlan_member_list1 }}\"
          - test_member_list2=\"{{ vlan_member_list2 }}\"
          - test_vid=\"0\"
          - test_pvid=\"0\"
          - test_dut_mac1=\"0\"
          - test_dut_mac2=\"0\"
          - test_ptf_mac1=\"0\"
          - test_ptf_mac2=\"0\"
          - test_ip1=\"0\"
          - test_ip2=\"0\"
          - test_case_str=\"Testcase1 verify the l2 traffic will be not forwarded in ports\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/l2_vlan_test1_step3.log"

  - name: add Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_create_vlan.yml
    with_items: "{{vlan_id}}"

  - set_fact: vlan_id={{vlan_id_list[3]}}

  - name: add port3/4 to Vlan{{vlan_id}} with untagged mode
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_add_port_to_vlan_untagged.yml
    with_items: "{{vlan_member_list2}}"

  - name: del port3/4 from Vlan{{vlan_id}}
    include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_del_port_from_vlan.yml
    with_items: "{{vlan_member_list2}}"

  rescue:
    - set_fact: failed_case="{{failed_case + ['l2_vlan_case1']}}"

  always: 
    - name: del vlan{{vlan_id_list}}
      include: roles/test/tasks/l2/l2_vlan/assist/l2_vlan_del_vlan.yml
      with_items: "{{ vlan_id_list }}"
