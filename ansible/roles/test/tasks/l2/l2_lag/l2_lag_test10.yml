
- set_fact:
    portchannel_id: 1
    portchannel_name: PortChannel1
    portchannel_member_list: [1,2,3,4]
    vlan_id: 1011
    dut_ip: 2000::1
    ptf_ip: 2000::2
    ptf_mac: 00:0c:29:e6:b4:01

- block:
  - name: Generate PortChannel config for PTF
    template: src=roles/test/templates/l2/l2_lag/l2_lag_ptf_portchannel_config_general.j2 dest=/tmp/PortChannel{{ portchannel_id }}.conf
    connection: local

  - name: Copy PortChanenl config files to the PTF host
    copy: src=/tmp/PortChannel{{ portchannel_id }}.conf dest=/tmp/PortChannel{{ portchannel_id }}.conf
    delegate_to: "{{ ptf_host }}"

  - name: Copy ptf init script to {{ ptf_host }}.
    become: true
    copy:
      src: roles/test/tasks/l2/l2_lag/assist/l2_lag_ptf.sh
      dest: /tmp
      mode: 0755
    delegate_to: "{{ ptf_host }}"

  - name: Init portchannel on ptf
    shell: /tmp/l2_lag_ptf.sh startup_portchannel_test10
    become: true
    delegate_to: "{{ ptf_host }}" 

  - name: Create Vlan{{vlan_id}}
    shell: config vlan add {{ vlan_id }}
    become: true

  - name: Create {{portchannel_name}}
    shell: config portchannel add {{ portchannel_name }}
    become: true 
   
  - name: Add {{portchannel_name}} to Vlan{{vlan_id}}
    shell: config vlan member add {{ vlan_id }} {{ portchannel_name }} --untagged
    become: true

  - name: Add members to {{portchannel_name}}
    include: roles/test/tasks/l2/l2_lag/assist/l2_lag_add_member.yml
    with_items:  "{{ portchannel_member_list }}"

  - name: Config Vlan{{vlan_id}} IP:{{dut_ip}}
    shell: config interface ip add Vlan{{ vlan_id }} {{ dut_ip }}/64
    become: true

  - name: ping dut from ptf
    shell: ping6 -c 5 {{ dut_ip }}
    become: true
    register: result
    delegate_to: "{{ ptf_host }}"

  - fail: msg="{{ping dut from ptf failed!}}"
    when: result.stdout.find("64 bytes from {{ dut_ip }}:") == -1

  - shell: ip neigh show
    become: true
    register: result

  - fail: msg="{{ARP learning failed!}}"
    when: result.stdout.find("{{ ptf_ip }} dev Vlan{{ vlan_id }} lladdr {{ ptf_mac }}") == -1

#  - shell: show mac
#    become: true
#    register: result

#  - fail: msg="{{ MAC learning failed! }}"
#    when: result.stdout.find("{{ ptf_mac }}  {{ portchannel_name }}") == -1
  
  rescue:
    - set_fact: failed_case="{{failed_case + ['l2_lag_case10']}}"

  always:
    - name: Del portchannel on ptf
      shell: /tmp/l2_lag_ptf.sh delete_portchannel_test10
      become: true
      delegate_to: "{{ ptf_host }}"

    - name: Del vlan interface IP:{{dut_ip}}
      shell: config interface ip remove vlan{{ vlan_id }} {{dut_ip}}/64
      become: true
      ignore_errors: true

    - name: Del member from {{portchannel_name}}
      include: roles/test/tasks/l2/l2_lag/assist/l2_lag_del_member.yml
      with_items:  "{{ portchannel_member_list }}"

    - name: Del {{portchannel_name}}
      shell: config portchannel del {{ portchannel_name }}
      become: true
      ignore_errors: true
   
    - name: Del Vlan{{vlan_id}} 
      shell: config vlan del {{ vlan_id }}
      become: true
      ignore_errors: true
