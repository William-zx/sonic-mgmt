- fail: msg="Invalid testbed_type value '{{testbed_type}}'"
  when: testbed_type not in [ 't0' ]

- set_fact:
   failed_case: []

- name: Generate port infor
  template: src=roles/test/templates/l2/l2_fdb/l2_fdb_port_info.j2 dest=/tmp/l2_fdb_port_info.yml
  connection: local
  become: true

- name: Load port info from file
  include_vars: '/tmp/l2_fdb_port_info.yml'

- debug: var=fdb_ports_list

- name: Copy tests to the PTF container
  copy: src=roles/test/files/ptftests dest=/root
  delegate_to: "{{ ptf_host }}" 

##############################################################
- name: Backup default config of dut
  command: cp /etc/sonic/config_db.json /etc/sonic/config_db_fdb.json
  become: true
  ignore_errors: true

- shell: config vlan member add {{ item.vid }} {{ item.dev }} --untagged
  become: true
  ignore_errors: true
  with_items: fdb_ports_list

- name: Del all ports from vlan on DUT
  shell: config vlan member del {{ item.vid }} {{item.dev}}
  become: true
  ignore_errors: true
  with_items: fdb_ports_list

- name: Save current config to configdb of dut
  command: config save -y
  become: true
  ignore_errors: true

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml
##############################################################

- name: Testcase1 verify MAC learning and FDB table queries
  include: l2/l2_fdb/l2_fdb_test1.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase2 verify multicast/broadcast/unknown unicast can be forwarded
  include: l2/l2_fdb/l2_fdb_test2.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase3 verify time aging function of fdb entry
  include: l2/l2_fdb/l2_fdb_test3.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase4 verify the port mac is cleared when the port downs
  include: l2/l2_fdb/l2_fdb_test4.yml

- name: Testcase5 verify the port mac is cleared when the port removed from vlan
  include: l2/l2_fdb/l2_fdb_test5.yml

- name: Testcase6 verify the mac related to vlan is cleared when the vlan is deleted
  include: l2/l2_fdb/l2_fdb_test6.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase7 verify the fdb table can be cleared using the command:sonic-clear fdb all
  include: l2/l2_fdb/l2_fdb_test7.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase8 verify the configuration and deletion of static mac and data forwarding based on static mac
  include: l2/l2_fdb/l2_fdb_test8.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase9 verify mac flapping
  include: l2/l2_fdb/l2_fdb_test9.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase10 verify mac learning from lag member
  include: l2/l2_fdb/l2_fdb_test10.yml

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml

- name: Testcase11 verify mac flapping between lag members
  include: l2/l2_fdb/l2_fdb_test11.yml

###############################################
#- name: Add all ports to vlan on DUT
#  shell: config vlan member add {{ item.vid }} {{ item.dev }} --untagged
#  become: true
#  ignore_errors: true
#  with_items: fdb_ports_list

- name: Recovery default config of dut
  command: mv /etc/sonic/config_db_fdb.json /etc/sonic/config_db.json
  become: true
  ignore_errors: true

- name: Reboot DUT
  include: roles/test/tasks/l2/l2_common/reboot_sonic.yml
###############################################

- fail: msg={{failed_case}}
  when: "{{failed_case|length}} != 0"

