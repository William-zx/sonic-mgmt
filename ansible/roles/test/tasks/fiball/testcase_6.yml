# Test Case 6  Verify Route nexthop interface down/up
- set_fact:
    static_route: "{{ static_routes.prefix8 }}"
    nh_interface: "{{ dut_if_vlan }}"
    nh_interface_ip_mask: "{{ minigraph_vlan_interfaces|selectattr('attachto', 'match', dut_if_vlan) | map(attribute='subnet')|first }}"
    nh_ip_mask: "{{ minigraph_vlan_interfaces|selectattr('attachto', 'match', dut_if_vlan) | map(attribute='subnet') | ipaddr(2) | first }}"
    nh_interface_peer_port: "{{ dut_if_vlan_peer_port_list[0] }}"
    
- set_fact:
    nh_ip: "{{nh_ip_mask|ipaddr('address')}}"

- name: flush arp/neigh on dut if
  shell: ip link set arp off dev {{ nh_interface }} && ip link set arp on dev {{ nh_interface }}
  become: yes

# Step1 Ping to trigger route nexthop resolve
- name: Add host ip
  shell: ip address add {{ nh_ip_mask }} dev eth{{ nh_interface_peer_port }}
  delegate_to: "{{ ptf_host }}"
  become: yes

- name: Ping from dut to host for trigger arp resolve
  shell: ping {{ nh_ip }} -c 3 -i0.2 -W2
  become: true

# Step2 add route with nexthop exist(with arp entry)
- name: Add static route which nexthop resolved.
  shell: vtysh -c "configure terminal" -c "ip route {{ static_route }} {{ nh_ip }}"
  become: yes  

# Step3 verify route are added success
- name: Use show to verify route is active
  shell: redis-cli -n 0 keys ROUTE_TABLE:{{ static_route }} | grep {{ static_route }}
  become: true

# Step4 Shutdown router interface
- name: Shutdown router interface {{ nh_interface }}
  shell: ip link set {{ nh_interface }} down
  become: true

# Step5: Verify connected route are removed, static route is removed
- name: Verify static route is removed
  shell: '! (redis-cli -n 0 keys ROUTE_TABLE:{{ static_route }} | grep {{ static_route }})'
  become: true

- name: Verify connected route is removed
  shell: redis-cli -n 0 keys ROUTE_TABLE:{{ nh_interface_ip_mask|ipaddr('subnet') }}
  register: out

- fail: msg="Connected route should be removed."
  when: nh_interface_ip_mask|ipaddr('subnet') in out.stdout

# Step6  verify ip traffic cannot be forwarded via this route
- name: Generate ptf test params
  set_fact:
    ingress_rif: "{{ dut_if_4 }}"
    dst_ip_addr_list: "{{ [dst_for_static_route] }}"
    dst_port_list: "{{ [nh_interface_peer_port] }}"
    src_port: "{{ dut_if_4_peer_port }}"

- name: verify ip traffic cannot be forwarded via this static route
  include: roles/test/tasks/ptf_runner.yml
  vars:
        ptf_test_name: Fiball testcase_6 step6
        ptf_test_dir: ptftests
        ptf_test_path: fiball_test.FiballTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - verbose=True
          - src_port={{ src_port }}
          - router_mac=\"{{ ansible_Ethernet0['macaddress'] }}\"
          - dst_ip_addr_list=\"{{ dst_ip_addr_list }}\"
          - dst_port_list=\"{{ dst_port_list }}\"
          - unexpected_ip_addr_list=\"{{ dst_ip_addr_list }}\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/fiball.testcase_6.step6.{{ lookup('pipe','date +%Y%m%d_%H%M%S') }}.log"

- name: verify ip traffic of subnet {{ nh_interface_ip_mask|ipaddr('subnet') }} should be forwared via default route
  include: roles/test/tasks/ptf_runner.yml
  vars:
        ptf_test_name: Fiball testcase_6 step6
        ptf_test_dir: ptftests
        ptf_test_path: fiball_test.FiballTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - verbose=True
          - src_port={{ src_port }}
          - router_mac=\"{{ ansible_Ethernet0['macaddress'] }}\"
          - dst_ip_addr_list=\"{{ [ nh_ip ] }}\"
          - dst_port_list=\"{{ [dut_if_1_peer_port, dut_if_2_peer_port, dut_if_3_peer_port, dut_if_4_peer_port] }}\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/fiball.testcase_6.step6.{{ lookup('pipe','date +%Y%m%d_%H%M%S') }}.log"

# Step7 Startup the router interface
- name: Startup router interface {{ nh_interface }}
  shell: ip link set {{ nh_interface }} up
  become: true

# Step8: Verify connected route and static route are resumed
- name: Verify static route is resumed
  shell: redis-cli -n 0 keys ROUTE_TABLE:{{ static_route }} | grep {{ static_route }}
  become: true

- name: Verify connected route is resumed
  shell: redis-cli -n 0 keys ROUTE_TABLE:{{ nh_interface_ip_mask|ipaddr('subnet') }}
  register: out

- fail: msg="Connected route should be resumed."
  when: nh_interface_ip_mask|ipaddr('subnet') not in out.stdout

# Step9 verify ip traffic can be forwarded via this route
- name: verify ip traffic can be forwarded via this route
  include: roles/test/tasks/ptf_runner.yml
  vars:
        ptf_test_name: Fiball testcase_6 step9
        ptf_test_dir: ptftests
        ptf_test_path: fiball_test.FiballTest
        ptf_platform_dir: ptftests
        ptf_platform: remote
        ptf_test_params:
          - verbose=True
          - src_port={{ src_port }}
          - router_mac=\"{{ ansible_Ethernet0['macaddress'] }}\"
          - dst_ip_addr_list=\"{{ dst_ip_addr_list }}\"
          - dst_port_list=\"{{ dst_port_list }}\"
        ptf_extra_options: "--relax --debug info --log-file /tmp/fiball.testcase_6.step9.{{ lookup('pipe','date +%Y%m%d_%H%M%S') }}.log"
